<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledesma Leonel - PP L III</title>
    <style>
        body {
            background-color: lightgrey;
        }

        table {            
            text-align: center;
            border-collapse: collapse;
            margin: 10px;
            font-size: 18px;
        }

        thead {
            background: whitesmoke;           
        }

        td {
            padding: 8px;
            background: #dff7f7;                        
            border: 4px solid white;            
            font-size: 18px;
            color: black;
            cursor: pointer;           
        }

        header {
            display: flex;
            justify-content: space-around;

        }

        h2 {
            text-align: center;
        }

        tr:hover td {
            background: #8bdaf7;            
            border: 4px solid white;   
            color: white;         
        }

        .pagina {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .show {
            display: flex;
            justify-content: space-between;
            background-color: #fff;
            border-radius: 10px;
            margin-top: 10px;
            padding: 5px;
        }        

        input.button {
            width: 100%;
            background-color: #0061d8;
            color: white;
            border: none;
            cursor: pointer;     
            padding: 8px 8px;       
        }

        div.alta input {
            width: 100%;
            border-radius: 10px;
        }

        input.button:hover {
            background-color: #87fff8;
        }       

        .botones{
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        div.divTabla {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .abm {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            flex-direction: column;
            padding: 16px;
            margin: 30px;
            top: 50px;
            border-radius: 4px;
            background-color: #dff7f7;
            width: 20%;
        }

        .abm label {    
            display: inline-block;    
            width: 100px;
            margin: 5px;
        }        

        .abm .error{background-color: red;
        width: 90%;}
    </style>
</head>

<body id="body">
    <div class="pagina">
        <h1>Formulario Ledesma Leonel</h1>
        <div id="divTabla">
            <header>
                <label>Filtrar por: </label>
                <select id="filtro">
                    <option value="Todos" selected>Todos</option>
                    <option value="Heroes">Heroes</option>
                    <option value="Villanos">Villanos</option>
                </select>

                <label>Calcular Edad Promedio:</label>
                <input type="text" id="edadPromedio" disabled>
                <input type="button" id="calcularEdadPromedio" value="Calcular">
            </header>

            <div class="show">
                <input type="checkbox" id="showColId" checked><span>Id</span>
                <input type="checkbox" id="showColNombre" checked><span>Nombre</span>
                <input type="checkbox" id="showColApellido" checked><span>Apellido</span>
                <input type="checkbox" id="showColEdad" checked><span>Edad</span>
                <input type="checkbox" id="showColAlterEgo" checked><span>AlterEgo</span>
                <input type="checkbox" id="showColCiudad" checked><span>Ciudad</span>
                <input type="checkbox" id="showColPublicado" checked><span>Publicado</span>
                <input type="checkbox" id="showColEnemigo" checked><span>Enemigo</span>
                <input type="checkbox" id="showColRobos" checked><span>Robos</span>
                <input type="checkbox" id="showColAsesinatos" checked><span>Asesinatos</span>
            </div>

            <table id="tabla">
                <thead id="tableHead">
                    <tr id="tableHeadTr" class="sort">
                        <th id="tablaId"><input class="button" type="button" id="orderById" value="Id"></th>
                        <th id="tablaNombre"><input class="button" type="button" id="orderByNombre" value="Nombre"></th>
                        <th id="tablaApellido"><input class="button" type="button" id="orderByApellido" value="Apellido"></th>
                        <th id="tablaEdad"><input class="button" type="button" id="orderByEdad" value="Edad"></th>
                        <th id="tablaAlterEgo"><input class="button" type="button" id="orderByAlterEgo" value="AlterEgo"></th>
                        <th id="tablaCiudad"><input class="button" type="button" id="orderByCiudad" value="Ciudad"></th>
                        <th id="tablaPublicado"><input class="button" type="button" id="orderByPublicado" value="Publicado"></th>
                        <th id="tablaEnemigo"><input class="button" type="button" id="orderByEnemigo" value="Enemigo"></th>
                        <th id="tablaRobos"><input class="button" type="button" id="orderByRobos" value="Robos"></th>
                        <th id="tablaAsesinatos"><input class="button" type="button" id="orderByAsesinatos" value="Asesinatos"></th>
                    </tr>
                </thead>
                <tbody id="bodyTabla">
                    <!--Aca se cargan las personas-->
                </tbody>
            </table>
        </div>

        <div class="alta">
            <input class="button" type="button" id="nuevaPersona" value="Dar de alta nueva persona">
        </div>

        <form class="abm" id="formAbm">
            <h2> Alta persona </h2>
            <div><label>ID:</label><input type="number" id="inputId" name="id" disabled></div>                
            <div><label>Nombre:</label><input type="text" id="inputNombre" name="nombre" ></div>                    
            <div><label>Apellido:</label><input type="text" id="inputApellido" name="apellido"></div>
            <div><label>Edad:</label><input type="text" id="inputEdad" name="edad" ></div>
            <div id="divSelect">
                <label>Tipo:</label>
                <select id="select">
                    <option value="Heroe">Heroe</option>
                    <option value="Villano">Villano</option>
                </select>
            </div>
            <div><label id="lblOpcional1">AlterEgo:</label><input type="text" id="inputOpcional1" ></div>
            <div><label id="lblOpcional2">Ciudad:</label><input type="text" id="inputOpcional2" ></div>
            <div><label id="lblOpcional3">Publicado:</label><input type="text" id="inputOpcional3" ></div>  
            
            <label id="error" class="error"></label>
            <div class="botones">
                <input type="button" class="boton" id="nuevo" value="Alta">
                <input type="button" class="boton" id="modificar" value="Modificar">
                <input type="button" class="boton" id="eliminar" value="Eliminar">
                <input type="button" class="boton" id="cancelar" value="Cancelar">
            </div>

        </form>

    </div>
</body>

<script>
    class Persona {
        id;
        nombre;
        apellido;
        edad;

        constructor(id, nombre, apellido, edad) {
            this.id = id;
            this.nombre = primerLetraMayuscula(nombre);
            this.apellido = primerLetraMayuscula(apellido);
            this.edad = edad;
        }
    }

    class Heroe extends Persona {

        alterEgo;
        ciudad;
        publicado;

        constructor(id, nombre, apellido, edad, alterEgo, ciudad, publicado) {
            super(id, nombre, apellido, edad);
            this.alterEgo = primerLetraMayuscula(alterEgo);
            this.ciudad = primerLetraMayuscula(ciudad);
            this.publicado = publicado;
        }
    }

    class Villano extends Persona {
        enemigo;
        robos;
        asesinatos;

        constructor(id, nombre, apellido, edad, enemigo, robos, asesinatos) {
            super(id, nombre, apellido, edad);
            this.enemigo = primerLetraMayuscula(enemigo);
            this.robos = robos;
            this.asesinatos = asesinatos;
        }
    }

    function primerLetraMayuscula(str)
    {   
        if(str!="")
        {
           str = str[0].toUpperCase() + str.substring(1);
        }
        return str;
    }
    

    //Carga del array
    let arrayPersonas = [];
    const jsonRecibido = '[{"id":1, "nombre":"Clark", "apellido":"Kent", "edad":45, "alterego":"Superman", "ciudad":"Metropolis","publicado":2002},{"id":2, "nombre":"Bruce", "apellido":"Wayne", "edad":35, "alterego":"Batman", "ciudad":"Gotica","publicado":20012},{"id":3, "nombre":"Bart", "apellido":"Alen", "edad":30, "alterego":"Flash", "ciudad":"Central","publicado":2017},{"id":4, "nombre":"Lex", "apellido":"Luthor", "edad":18, "enemigo":"Superman", "robos":500,"asesinatos":7},{"id":5, "nombre":"Harvey", "apellido":"Dent", "edad":20, "enemigo":"Batman", "robos":750,"asesinatos":2},{"id":666, "nombre":"Celina", "apellido":"kyle", "edad":23, "enemigo":"Batman", "robos":25,"asesinatos":1}]'
    let array = JSON.parse(jsonRecibido);    
    arrayPersonas = array.map(object => {
        if (isHeroeJSON(object) && heroeValido(object))
            return new Heroe(object.id, object.nombre, object.apellido, object.edad, object.alterego, object.ciudad, object.publicado)

        else if (isVillanoJSON(object) && villanoValido(object))
            return new Villano(object.id, object.nombre, object.apellido, object.edad, object.enemigo, object.robos, object.asesinatos);
    });

    //Validaciones
    function isHeroeJSON(object) {
        return object.hasOwnProperty("alterego") &&
            object.hasOwnProperty("ciudad") &&
            object.hasOwnProperty("publicado")
    }

    function isVillanoJSON(object) {
        return object.hasOwnProperty("enemigo")
            && object.hasOwnProperty("robos")
            && object.hasOwnProperty("asesinatos");
    }

    function personaValida(object) {
        return object.id != "" && object.nombre != "" && object.nombre != null && object.apellido != "" && object.edad % 1 == 0 && object.edad>0;
    }    

    function villanoValido(object) {
        return personaValida(object) && object.enemigo != "" && object.robos % 1 == 0 && object.robos > 0 && object.asesinatos % 1 == 0 && object.asesinatos > 0;
    }

    function heroeValido(object) {
        return personaValida(object) && object.alterEgo != ""  && object.ciudad != "" && object.publicado % 1 == 0 && object.publicado > 1940;
    }


    // Formulario ALTA
    let btnNuevaPersona = document.getElementById("nuevaPersona");
    btnNuevaPersona.addEventListener("click", cambiarVisibilidad)    

    let botonAlta = document.getElementById("nuevo");
    botonAlta.addEventListener("click", agregarPersona);

    let botonCancelar = document.getElementById("cancelar");
    botonCancelar.addEventListener("click", cambiarVisibilidad)
    
    let botonModificar = document.getElementById("modificar");
    botonModificar.addEventListener("click", modificarPersona);

    let select = document.getElementById("select");
    select.addEventListener("change", cambiarOpciones)

    //Se carga al hacer doble click
    let personaAModificar = null;
    var mensajeAlert = "";

    function agregarPersona() {
        mensajeAlert = "";
        let alta = leerDatos();
        if (alta != null && validarId(alta.id)) {           

            arrayPersonas.push(alta);
            limpiarTabla();
            generarTabla();
            cambiarVisibilidad();
        }
        else {
            let lblError = document.getElementById("error");
            lblError.innerHTML = mensajeAlert;
        }
        
    }

    function generarId()
    {
        let id;
        do{
            id = Math.floor(Math.random() * 10000)+1;
        }while(arrayPersonas.some(p=>p.id==id))

        return id;
    }

    function leerDatos() {
        let personaRecibida;
        let id = document.getElementById("inputId").value;   
        
        //nueva entidad, viene con id vacio
        if(id=="")
        {
            id = generarId();
        }     

        let nombre = document.getElementById("inputNombre").value;
        let apellido = document.getElementById("inputApellido").value;
        let edad = document.getElementById("inputEdad").value;

        //La seleccion es heroe
        if (document.getElementById("select").value == "Heroe") {
            let alterEgo = document.getElementById("inputOpcional1").value;
            let ciudad = document.getElementById("inputOpcional2").value;
            let publicado = document.getElementById("inputOpcional3").value;
            personaRecibida = new Heroe(id, nombre, apellido, edad, alterEgo, ciudad, publicado);

            if (heroeValido(personaRecibida)) {
                personaRecibida.id = parseInt(personaRecibida.id);
                personaRecibida.edad = parseInt(personaRecibida.edad);
                personaRecibida.publicado = parseInt(personaRecibida.publicado);

                //Tiramos a undefine los otros en caso de modificacion de tipo.
                personaRecibida.enemigo = undefined;
                personaRecibida.asesinatos = undefined;
                personaRecibida.robos = undefined;

                return personaRecibida;
            }else{
                mensajeAlert += "Hay en un error en la carga de los campos";
            }
        } else //Es villano
        {
            let enemigo = document.getElementById("inputOpcional1").value;
            let robos = document.getElementById("inputOpcional2").value;
            let asesinatos = document.getElementById("inputOpcional3").value;
            personaRecibida = new Villano(id, nombre, apellido, edad, enemigo, robos, asesinatos);

            if (villanoValido(personaRecibida)) {
                personaRecibida.id = parseInt(personaRecibida.id);
                personaRecibida.edad = parseInt(personaRecibida.edad);
                personaRecibida.asesinatos = parseInt(personaRecibida.asesinatos);
                personaRecibida.robos = parseInt(personaRecibida.robos);

                //Tiramos a undefine los otros en caso de modificacion de tipo.                
                personaRecibida.alterEgo = undefined;
                personaRecibida.ciudad = undefined;
                personaRecibida.publicado = undefined;

                return personaRecibida;
            }
            else{
                mensajeAlert += "Hay en un error en la carga de los campos"
            }
        }

        return null;
    }

    function cambiarOpciones() {
        if (document.getElementById("select").value == "Heroe") {
            document.getElementById("lblOpcional1").innerHTML = "AlterEgo:";
            document.getElementById("lblOpcional2").innerHTML = "Ciudad:";
            document.getElementById("lblOpcional3").innerHTML = "Publicado:";
        }
        else {
            document.getElementById("lblOpcional1").innerHTML = "Enemigo:";
            document.getElementById("lblOpcional2").innerHTML = "Robos:";
            document.getElementById("lblOpcional3").innerHTML = "Asesinatos:";
        }
    }

    function validarId(id) {        
        return !arrayPersonas.some(persona => persona.id == id);
    }

    function cambiarVisibilidad() {
        let e = document.getElementById("formAbm");
        let tabla = document.getElementById("divTabla");
        let boton = document.getElementById("nuevaPersona");
        mensajeAlert = "";
        //Veo la tabla
        if (e.style.display == "") {
            e.style.display = "none";
            tabla.style.display = "";
            boton.value = "Nueva persona";
            //Reinicio abm
            limpiarCampos();            
            document.getElementById("nuevo").style.display="";
            document.getElementById("modificar").style.display="none";
            document.getElementById("eliminar").style.display="none";
        }
        else { //Veo tabla
            e.style.display = "";
            tabla.style.display = "none";
            boton.value = "Volver";
            divSelect.style.display="";
        }
    }

    function cargarCampos() {
        let idClickeado = event.target.parentNode.id; //id del nodo es igual al id de la entidad
        personaAModificar = arrayPersonas.find(p => p.id == idClickeado);

        cambiarVisibilidad();

        document.getElementById("formAbm").style.display = "";

        let id = document.getElementById("inputId").value = personaAModificar.id;

        document.getElementById("inputNombre").value = personaAModificar.nombre;
        document.getElementById("inputApellido").value = personaAModificar.apellido;
        document.getElementById("inputEdad").value = personaAModificar.edad;

        let divSelect = document.getElementById("divSelect");
        divSelect.style.display="none";
        
        if (personaAModificar instanceof Villano) {            
            document.getElementById("select").value = "Villano";
            cambiarOpciones();
        }

        document.getElementById("inputOpcional1").value = personaAModificar.alterEgo || personaAModificar.enemigo;
        document.getElementById("inputOpcional2").value = personaAModificar.ciudad || personaAModificar.robos;
        document.getElementById("inputOpcional3").value = personaAModificar.asesinatos || personaAModificar.publicado;        

        document.getElementById("nuevo").style.display="none";
        document.getElementById("modificar").style.display="";
        document.getElementById("eliminar").style.display="";
    }

    function limpiarCampos()
    {
        document.getElementById("inputId").value = "";
        document.getElementById("inputNombre").value =  "";
        document.getElementById("inputApellido").value =  "";
        document.getElementById("inputEdad").value =  "";
        document.getElementById("select").value = "Heroe";
        cambiarOpciones();
        document.getElementById("inputOpcional1").value =  "";
        document.getElementById("inputOpcional2").value =  "";
        document.getElementById("inputOpcional3").value =  "";
        document.getElementById("error").innerHTML="";
        personaAModificar=null;
    }

    function modificarPersona(){
        mensajeAlert = "";
        let personaLeida = leerDatos();        
        let index = arrayPersonas.indexOf(personaAModificar);

        if(personaLeida !=null )
        {
            arrayPersonas[index] = personaLeida
        }else
        {
            alert("Ocurrio un error.")
        }
        
        generarTabla();
        cambiarVisibilidad();
    }

    //----------------------------------------TABLA-------------------------------------

    var filtro = document.getElementById("filtro");
    filtro.addEventListener("change", generarTabla);

    let calcular = document.getElementById("calcularEdadPromedio");
    calcular.addEventListener("click", calcularEdadPromedio);

    let botonEliminar = document.getElementById("eliminar");
    botonEliminar.addEventListener("click", eliminarPersona)

    function calcularEdadPromedio() { 
       
        let filtro = document.getElementById("filtro").value;
        

        const edadTotal = arrayPersonas.reduce((valorAnterior, elemento, indice, vector) => {        
            switch(filtro)
            {
                case "Todos":
                    return valorAnterior + elemento.edad;
                    break;
                case "Heroes":                   
                    if(elemento instanceof Heroe)
                    {
                        return valorAnterior + elemento.edad;
                    }
                    break;
                case "Villanos":
                    if(elemento instanceof Villano)
                    return valorAnterior + elemento.edad;
                    break;
            }
            return valorAnterior;   

            
        }, 0);

        let salida = document.getElementById("edadPromedio");
        salida.value = edadTotal / arrayPersonas.length;

    }

    function generarTabla() {
        limpiarTabla();
        let filtroTipo = filtro.value;

        let bodyTabla = document.getElementById("bodyTabla");
        let personasMostradas = new Array();

        if (bodyTabla.childElementCount == 0) {
            arrayPersonas.forEach(persona => {
                switch (filtroTipo) {
                    case "Todos":
                        personasMostradas.push(persona);
                        break;
                    case "Heroes":
                        (persona instanceof Heroe) ? personasMostradas.push(persona) : null;
                        break;
                    case "Villanos":
                        (persona instanceof Villano) ? personasMostradas.push(persona) : null;
                        break;
                }
            })
            insertarPersonas(personasMostradas);
        }
    }

    function insertarPersonas(personas) {
        let bodyTabla = document.getElementById("bodyTabla");

        //recorro las personas a mostrar        
        personas.forEach(persona => {
            let arrayPersona = [persona.id, persona.nombre, persona.apellido, persona.edad, persona.alterEgo, persona.ciudad, persona.publicado, persona.enemigo, persona.robos, persona.asesinatos];
            let nuevoTr = document.createElement("tr")    
            nuevoTr.addEventListener("dblclick", cargarCampos)        
            nuevoTr.id = persona.id;

            //Recorro los atributos
            arrayPersona.forEach(atributo => {
                let td = document.createElement("td");
                td.id = "td" + arrayPersona[0] + "-" + atributo;
                td.textContent = atributo;
                nuevoTr.appendChild(td);
            });
            bodyTabla.appendChild(nuevoTr)
        })
    }

    function limpiarTabla() {
        let bodyTabla = document.getElementById("bodyTabla");
        bodyTabla.innerHTML = "";
        document.getElementById("edadPromedio").value = "";
    }

    function eliminarPersona(){
        let trs = document.getElementById("bodyTabla").childNodes;
        if(confirm("¿Desea eliminar a " + personaAModificar.nombre + " " + personaAModificar.apellido + "?"))
        {
            let index= arrayPersonas.indexOf(personaAModificar);
            arrayPersonas.splice(index,1);
            generarTabla();
            cambiarVisibilidad();
        }
    }

    //Ocultar/Mostrar Columa
    let arrayShow = new Array();
    arrayShow.push(document.getElementById("showColId"),
            document.getElementById("showColNombre"),
            document.getElementById("showColApellido"),
            document.getElementById("showColEdad"),
            document.getElementById("showColAlterEgo"),
            document.getElementById("showColCiudad"),
            document.getElementById("showColPublicado"),
            document.getElementById("showColEnemigo"),
            document.getElementById("showColRobos"),
            document.getElementById("showColAsesinatos"))            

    arrayShow.map((check, index) => {
            check.addEventListener("change", cambiarVisibilidadCheck)
            check.textContent = index;
        });

    function cambiarVisibilidadCheck(e)
    {
        let checked = e.currentTarget;
        let colIndex = checked.textContent;
        let tableBody = document.querySelector("#bodyTabla");
        
        let tableHeadTr = document.getElementById("tableHeadTr");
        let childs = Array.from(tableHeadTr.childNodes)
        let tdHead = childs.filter(node => (node.nodeName == "TH" && node.cellIndex==colIndex)).pop();

        if(!checked.checked) //No está chequeado
        {
            tableBody.childNodes.forEach(tr => {
                //oculto tbody
                tr.childNodes[colIndex].style.display="none";
            });

            //Oculto cabezera
            tdHead.style.display="none";
            
        }else
        {
            tableBody.childNodes.forEach(tr => {
                //muestro tbodys
                tr.childNodes[colIndex].style.display="";
            });

            //muestro td
            tdHead.style.display="";
        }
    }

    //Ordenar por columna

    let arrayOrderBy = new Array();
    arrayOrderBy.push(document.getElementById("orderById"),
            document.getElementById("orderByNombre"),
            document.getElementById("orderByApellido"),
            document.getElementById("orderByEdad"),
            document.getElementById("orderByAlterEgo"),
            document.getElementById("orderByCiudad"),
            document.getElementById("orderByPublicado"),
            document.getElementById("orderByEnemigo"),
            document.getElementById("orderByRobos"),
            document.getElementById("orderByAsesinatos")
            );

    arrayOrderBy.forEach(input => { input.addEventListener("click", ordenar)});

    let ordenado;

    function ordenar()
    {
        //consigo el id, y le saco el orderBy, ["", atributo]
        let atributo = event.target.id.split("orderBy")[1];                
        //Hago a lower la primer letra y acoplo
        atributo = atributo[0].toLowerCase() + atributo.substring(1);                
        switch(ordenado)
        {                     
            case "descendente":            
                arrayPersonas.sort( (a, b) => a[atributo] ? (a[atributo] < b[atributo])? 1 : (b[atributo] == a[atributo]? 0 : -1) : ""); 
                ordenado = "ascendente";
                break;
            case "ascendente":
            default:
                arrayPersonas.sort( (a, b) => a[atributo] ? (a[atributo] > b[atributo])? 1 : (b[atributo] == a[atributo]? 0 : -1): "")
                ordenado = "descendente";
                break;           
        }
        
        generarTabla();
    }

    //Carga inicial
    let body = document.getElementById("body");
    body.addEventListener("load", cargaInicial());


    function cargaInicial() {
        arrayPersonas.push(new Heroe(124, "leonel", "ledesma", 22,"Boca", "La boca", 1960));
        cambiarVisibilidad();
        generarTabla();
    }

</script>

</html>